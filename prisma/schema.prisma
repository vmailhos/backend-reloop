// prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

//
// USERS
//
model User {
  id        String    @id @default(cuid())
  email     String    @unique
  username  String    @unique
  password  String
  emailVerifiedAt         DateTime?
  emailVerificationToken  String?
  emailVerificationExpiresAt DateTime?
  resetPasswordToken     String?
  resetPasswordExpiresAt DateTime?
  name      String?
  lastName  String?
  phone     String?
  gender    String?
  birthDate DateTime?
  avatar    String?
  country   String?
  createdAt DateTime  @default(now())

  listings               Listing[]
  favorites              Favorite[]
  ratingsGiven           Rating[]                @relation("ratings_given")
  ratingsReceived        Rating[]                @relation("ratings_received")
  offersSent             Offer[]                 @relation("buyer_offers")
  offersReceived         Offer[]                 @relation("seller_offers")
  buyerThreads  CommentThread[] @relation("buyer_threads")
  sellerThreads CommentThread[] @relation("seller_threads")
  cart                   CartItem[]
  orders                 Order[]
  notifications          Notification[]
  notificationPreference NotificationPreference?
  comments               Comment[]
}

//
// LISTINGS
//
model Listing {
  id             String          @id @default(cuid())
  title          String
  description    String?
  price          Decimal         @db.Decimal(10, 2)
  condition      Condition
  category       Category
  subCategory    SubCategory?
  subSubCategory SubSubCategory?

  brand String?
  color String?

  sizeTop       TopSize?
  sizeBottom    BottomSize?
  sizeShoe      ShoeSize?
  sizeAccessory AccessorySize?
  sizeKids      KidsSize?
  sizeKidsShoe  KidsShoeSize?

  status String @default("available")

  // Discount system: percentage-based discount (0-90%)
  // Original price is preserved in 'price' field
  // Discounted price is calculated on-the-fly
  discountPercent Decimal? @db.Decimal(5, 2)

  sellerId String
  seller   User   @relation(fields: [sellerId], references: [id])
  commentThreads CommentThread[]

  photos     Photo[]
  favorites  Favorite[]
  ratings    Rating[]
  createdAt  DateTime    @default(now())
  offers     Offer[]
  orderItems OrderItem[]
  cartItems  CartItem[]

  @@index([title])
  @@index([category])
  @@index([subCategory])
  @@index([condition])
  @@index([brand])
  @@index([price])
  @@index([createdAt])
}

//
// PHOTOS
//
model Photo {
  id        String   @id @default(cuid())
  url       String
  order     Int      // ðŸ‘ˆ NUEVO
  listing   Listing  @relation(fields: [listingId], references: [id])
  listingId String
}

//
// FAVORITES
//
model Favorite {
  id        String  @id @default(cuid())
  userId    String
  listingId String
  user      User    @relation(fields: [userId], references: [id])
  listing   Listing @relation(fields: [listingId], references: [id])

  @@unique([userId, listingId])
}

//
// RATINGS
//
model Rating {
  id        String   @id @default(cuid())
  value     Int
  comment   String?
  createdAt DateTime @default(now())

  authorId String
  author   User   @relation("ratings_given", fields: [authorId], references: [id])

  targetId String
  target   User   @relation("ratings_received", fields: [targetId], references: [id])

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id])
}

model Offer {
  id String @id @default(cuid())

  listingId String
  buyerId   String
  sellerId  String

  amount Decimal @db.Decimal(10, 2) // oferta inicial del buyer

  status OfferStatus @default(PENDING)

  counterOfferAmount Decimal? @db.Decimal(10, 2) // si el seller contraoferta
  acceptedPrice      Decimal? @db.Decimal(10, 2) // âœ… precio final acordado (clave)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // relaciones (ajustÃ¡ nombres/relations a tus modelos reales)
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyer   User    @relation("buyer_offers", fields: [buyerId], references: [id], onDelete: Cascade)
  seller  User    @relation("seller_offers", fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([buyerId, createdAt])
  @@index([sellerId, createdAt])
  @@index([listingId, createdAt])
}

model CommentThread {
  id        String   @id @default(cuid())
  listingId String
  buyerId   String
  sellerId  String
  createdAt DateTime @default(now())

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyer   User    @relation("buyer_threads", fields: [buyerId], references: [id], onDelete: Cascade)
  seller  User    @relation("seller_threads", fields: [sellerId], references: [id], onDelete: Cascade)

  comments Comment[]

  @@unique([listingId, buyerId]) // ðŸ”¥ UN THREAD POR USUARIO
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())

  authorId  String
  author    User   @relation(fields: [authorId], references: [id])

  threadId  String
  thread    CommentThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
}


model CartItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  listingId String
  listing   Listing @relation(fields: [listingId], references: [id])

  @@unique([userId, listingId])
}

model Order {
  id          String      @id @default(cuid())
  subtotal      Decimal @db.Decimal(10, 2)
  commission    Decimal @db.Decimal(10, 2)
  totalAmount   Decimal @db.Decimal(10, 2)
  commissionPct Decimal @db.Decimal(5, 2) @default(3.0)
  status      OrderStatus @default(PENDING)
  createdAt   DateTime    @default(now())

  buyerId String
  buyer   User   @relation(fields: [buyerId], references: [id])

  items OrderItem[]

  shippingProvider String?   // "DAC"
  shippingType     String?   // "HOME" | "AGENCY"
  shippingData     Json?     // snapshot completo
  shippingTicketUrl String?
  shippedAt        DateTime?
  receivedAt       DateTime?
}

model OrderItem {
  id    String  @id @default(cuid())
  price Decimal @db.Decimal(10, 2)

  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  listingId String
  listing   Listing @relation(fields: [listingId], references: [id])
}

//
// ENUMS DEL SISTEMA
//

enum Condition {
  NUEVO_CON_ETIQUETA
  NUEVO_SIN_ETIQUETA
  MUY_BUENO
  BUENO
  SATISFACTORIO
}

enum Category {
  HOMBRE
  MUJER
  NINOS
  UNISEX
}

enum SubCategory {
  ROPA
  ACCESORIOS
  CALZADOS
}

enum SubSubCategory {
  Todos
  Remeras
  Camisas
  Tops
  Pantalones
  Bermudas
  Shorts
  Camperas
  Vestidos
  Buzos
  Faldas
  Blazers
  Carteras
  Sombreros
  Gorros
  Lentes
  Bijou
  Cinturones
  Guantes
  Bufandas
  Joyas
  Sandalias
  Botas
  Zapatillas
  Tacos
}

// TALLE SUPERIOR (remeras, buzos, camperas, camisas, tops, blazers, vestidos)
enum TopSize {
  TS_XXS
  TS_XS
  TS_S
  TS_M
  TS_L
  TS_XL
  TS_XXL
  TS_XXXL
  TS_U
}

// TALLE INFERIOR (pantalones, jeans, shorts, faldas)
enum BottomSize {
  TB_XXS
  TB_XS
  TB_S
  TB_M
  TB_L
  TB_XL
  TB_XXL
  TB_U
  TB_30
  TB_32
  TB_34
  TB_36
  TB_38
  TB_40
  TB_42
  TB_44
  TB_46
  TB_48
}

// CALZADO ADULTO
enum ShoeSize {
  SH_33
  SH_34
  SH_35
  SH_36
  SH_37
  SH_38
  SH_39
  SH_40
  SH_41
  SH_42
  SH_43
  SH_44
  SH_45
  SH_46
}

// ROPA NIÃ‘OS
enum KidsSize {
  K_0_3M
  K_3_6M
  K_6_9M
  K_9_12M
  K_12_18M
  K_18_24M
  K_2
  K_3
  K_4
  K_5
  K_6
  K_7
  K_8
  K_10
  K_12
  K_14
  K_16
}

// CALZADO NIÃ‘OS
enum KidsShoeSize {
  KS_16
  KS_17
  KS_18
  KS_19
  KS_20
  KS_21
  KS_22
  KS_23
  KS_24
  KS_25
  KS_26
  KS_27
  KS_28
  KS_29
  KS_30
  KS_31
  KS_32
  KS_33
}

// ACCESORIOS
enum AccessorySize {
  A_U
  A_S
  A_M
  A_L
  A_XL
}

enum OfferStatus {
  PENDING
  COUNTERED
  ACCEPTED
  REJECTED
  EXPIRED
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  COMPLETED
  CANCELLED
}

//
// NOTIFICATIONS
//
model Notification {
  id     String @id @default(cuid())
  userId String

  type     String
  title    String
  message  String
  metadata Json?

  read Boolean @default(false)

  // Future delivery channels
  sendEmail Boolean   @default(false)
  sendPush  Boolean   @default(false)
  emailedAt DateTime?
  pushedAt  DateTime?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model NotificationPreference {
  id     String @id @default(cuid())
  userId String @unique

  emailSales     Boolean @default(true)
  emailPurchases Boolean @default(true)
  emailFavorites Boolean @default(false)

  pushSales     Boolean @default(true)
  pushPurchases Boolean @default(true)
  pushFavorites Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
