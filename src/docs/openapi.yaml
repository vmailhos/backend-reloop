openapi: 3.0.3
info:
  title: Reloop API
  version: 0.1.0
  description: |
    API del backend de Reloop (MVP).
    Autenticación JWT, publicaciones, favoritos y subidas locales (dev).

servers:
  - url: http://localhost:3000
    description: Local

tags:
  - name: Health
  - name: Auth
  - name: Listings
  - name: Favorites
  - name: Uploads

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Error:
      type: object
      properties:
        error: { type: string, example: validation_error }
        message: { type: string, example: Campo requerido }
        details:
          type: array
          items: { type: object }
      additionalProperties: true

    AuthLogin:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email, example: sofi@example.com }
        password: { type: string, minLength: 6, example: "123456" }

    AuthToken:
      type: object
      properties:
        token: { type: string, example: eyJhbGciOi... }

    Photo:
      type: object
      properties:
        id: { type: string, example: clxyz... }
        url: { type: string, example: uploads/foto1.png }

    UserPublic:
      type: object
      properties:
        id: { type: string, example: clxyz... }
        email: { type: string, format: email, example: sofi@example.com }

    Listing:
      type: object
      properties:
        id: { type: string, example: clxyz... }
        title: { type: string, example: Vestido lila }
        price: { type: number, example: 1200 }
        category: { type: string, example: vestidos }
        condition:
          type: string
          enum: [nuevo, como_nuevo, usado]
          example: como_nuevo
        seller: { $ref: '#/components/schemas/UserPublic' }
        photos:
          type: array
          items: { $ref: '#/components/schemas/Photo' }
        createdAt: { type: string, format: date-time }

    ListingCreate:
      type: object
      required: [title, price]
      properties:
        title: { type: string, example: Remera azul }
        price: { type: number, example: 900 }
        category: { type: string, example: remeras }
        condition: { type: string, enum: [nuevo, como_nuevo, usado], example: usado }
        photos:
          type: array
          items:
            type: object
            properties:
              url: { type: string, example: uploads/foto1.png }

    ListingUpdate:
      type: object
      properties:
        title: { type: string }
        price: { type: number }
        category: { type: string }
        condition: { type: string, enum: [nuevo, como_nuevo, usado] }
        photos:
          type: array
          items:
            type: object
            properties:
              url: { type: string }

    ListingListResponse:
      type: object
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/Listing' }
        total: { type: integer, example: 2 }
        page: { type: integer, example: 1 }
        pageSize: { type: integer, example: 20 }

    FavoriteItem:
      type: object
      properties:
        id: { type: string, example: cllist... }
        title: { type: string, example: Campera denim }
        price: { type: number, example: 2500 }
        category: { type: string, example: camperas }
        condition: { type: string, enum: [nuevo, como_nuevo, usado], example: usado }
        photo: { type: string, nullable: true, example: uploads/foto2.png }
        seller: { $ref: '#/components/schemas/UserPublic' }
        favoriteId: { type: string, example: clfav... }

    FavoritesListResponse:
      type: object
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/FavoriteItem' }
        total: { type: integer, example: 1 }
        page: { type: integer, example: 1 }
        pageSize: { type: integer, example: 20 }

    UploadBase64Req:
      type: object
      required: [filename, base64]
      properties:
        filename: { type: string, example: foto.png }
        base64: { type: string, example: iVBORw0KGgoAAA... }

    UploadBase64Res:
      type: object
      properties:
        ok: { type: boolean, example: true }
        path: { type: string, example: uploads/169999999-foto.png }

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string, example: ok }

  /auth/signup:
    post:
      tags: [Auth]
      summary: Crear usuario
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AuthLogin' }
      responses:
        '201': { description: Creado }
        '409':
          description: Email ya utilizado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '400':
          description: Error de validación
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /auth/login:
    post:
      tags: [Auth]
      summary: Login (devuelve JWT)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AuthLogin' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AuthToken' }
        '401':
          description: Credenciales inválidas
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '400':
          description: Error de validación/JSON
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /listings:
    get:
      tags: [Listings]
      summary: Listar publicaciones
      parameters:
        - in: query
          name: search
          schema: { type: string }
        - in: query
          name: category
          schema: { type: string }
        - in: query
          name: minPrice
          schema: { type: number, minimum: 0 }
        - in: query
          name: maxPrice
          schema: { type: number, minimum: 0 }
        - in: query
          name: page
          schema: { type: integer, default: 1, minimum: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 20, minimum: 1, maximum: 100 }
        - in: query
          name: sort
          schema:
            type: string
            enum: [newest, price_asc, price_desc]
            default: newest
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ListingListResponse' }

    post:
      tags: [Listings]
      summary: Crear publicación
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ListingCreate' }
      responses:
        '201':
          description: Creado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Listing' }
        '400':
          description: Error de validación
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Token inválido/faltante
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /listings/mine:
    get:
      tags: [Listings]
      summary: Mis publicaciones (usuario autenticado)
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Listing' }
                  total: { type: integer }
        '401':
          description: Token inválido/faltante
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /listings/{id}:
    get:
      tags: [Listings]
      summary: Detalle de publicación
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Listing' }
        '404':
          description: No encontrado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

    patch:
      tags: [Listings]
      summary: Editar publicación propia
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ListingUpdate' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Listing' }
        '403':
          description: Forbidden (no es dueño)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Token inválido/faltante
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '404':
          description: No encontrado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

    delete:
      tags: [Listings]
      summary: Borrar publicación propia
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
        '403':
          description: Forbidden (no es dueño)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Token inválido/faltante
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '404':
          description: No encontrado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /favorites:
    get:
      tags: [Favorites]
      summary: Listar favoritos del usuario
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1, minimum: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 20, minimum: 1, maximum: 100 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/FavoritesListResponse' }
        '401':
          description: Token inválido/faltante
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /favorites/{listingId}:
    get:
      tags: [Favorites]
      summary: Estado de favorito (isFavorite)
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: listingId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  isFavorite: { type: boolean, example: true }
                  favoriteId: { type: string, nullable: true, example: clfav... }
        '401':
          description: Token inválido/faltante
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

    post:
      tags: [Favorites]
      summary: Agregar a favoritos (idempotente)
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: listingId
          required: true
          schema: { type: string }
      responses:
        '201': { description: Creado/Existente }
        '404':
          description: listing_not_found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '400':
          description: cannot_favorite_own_listing
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Token inválido/faltante
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

    delete:
      tags: [Favorites]
      summary: Quitar de favoritos
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: listingId
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
        '401':
          description: Token inválido/faltante
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /uploads/local:
    post:
      tags: [Uploads]
      summary: Subida de archivo en base64 (dev/local)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UploadBase64Req' }
      responses:
        '201':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UploadBase64Res' }
        '400':
          description: bad_request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
